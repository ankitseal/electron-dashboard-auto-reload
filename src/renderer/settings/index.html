<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --bg-alt: #ffffff;
      --border: #dce2eb;
      --border-strong: #c3ccd7;
      --text: #1f2933;
      --text-soft: #5a6b7b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #b91c1c;
      --radius: 10px;
      --focus: 0 0 0 3px rgba(37,99,235,0.35);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.08);
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --gradient: linear-gradient(92deg,#2563eb,#4f46e5 55%, #9333ea);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111827;
        --bg-alt: #1f2937;
        --border: #2d3a4a;
        --border-strong: #435467;
        --text: #f3f4f6;
        --text-soft: #9ca3af;
        --accent: #3b82f6;
        --accent-hover: #1d4ed8;
        --danger: #f87171;
        --gradient: linear-gradient(92deg,#3b82f6,#6366f1 55%, #8b5cf6);
        --shadow: 0 4px 16px rgba(0,0,0,0.55);
      }
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
    h2 { margin:0; font-size: 18px; font-weight:600; letter-spacing:.5px; }
    #topBar { position: sticky; top:0; z-index:200; display:flex; align-items:center; justify-content:space-between; gap:24px; padding:14px 20px; background: var(--gradient); color:#fff; box-shadow: var(--shadow); }
    #topBar .meta { display:flex; align-items:center; gap:14px; font-size: 12px; opacity:.9; }
    #topBar button { background: rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:8px 18px; font-size:13px; letter-spacing:.5px; text-transform:uppercase; border-radius: 30px; font-weight:600; cursor:pointer; backdrop-filter: blur(3px); transition: background .18s,border-color .18s, transform .15s; }
    #topBar button:hover { background: rgba(255,255,255,0.28); }
    #topBar button:active { transform: translateY(1px) scale(.98); }
    #topBar button:focus-visible { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.5); }
    #layout { max-width: 980px; margin: 28px auto 64px; padding:0 28px 56px; }
    fieldset { margin:0 0 28px; border:1px solid var(--border); padding:18px 20px 20px; border-radius: var(--radius); position:relative; background: var(--bg-alt); box-shadow: var(--shadow-sm); }
    fieldset:hover { border-color: var(--border-strong); }
    legend { padding:0 10px; font-size:13px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; color: var(--text-soft); }
    label { display:block; margin:8px 0 4px; font-weight:600; font-size:13px; letter-spacing:.25px; }
    input[type=text], input[type=password], input[type=number], select { width:100%; padding:10px 12px; font: 14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; border:1px solid var(--border); border-radius:8px; background: var(--bg-alt); color: var(--text); box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); transition:border-color .15s, background .25s; }
    input:focus, select:focus { outline:none; border-color: var(--accent); box-shadow: var(--focus); }
    .row { display:grid; gap:18px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    label.toggle {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      font-weight:600;
      margin:12px 0;
    }
    label.toggle .toggle-text {
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
    }
    label.toggle input[type=checkbox] {
      appearance:none;
      width:46px;
      height:28px;
      border-radius:999px;
      background: var(--border);
      position:relative;
      transition: background .25s ease;
      cursor:pointer;
      border:2px solid transparent;
    }
    label.toggle input[type=checkbox]::after {
      content:'';
      position:absolute;
      top:2px;
      left:2px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,0.25);
      transition: transform .25s ease;
    }
    label.toggle input[type=checkbox]:checked {
      background: var(--accent);
    }
    label.toggle input[type=checkbox]:checked::after {
      transform: translateX(20px);
    }
    label.toggle input[type=checkbox]:focus-visible {
      outline:none;
      box-shadow: var(--focus);
    }
    label.toggle input[type=checkbox]:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    label.toggle input[type=checkbox]:disabled::after {
      background:#f8f9fb;
    }
    .collapsible {
      overflow:hidden;
      max-height:0;
      opacity:0;
      transition:max-height .35s ease, opacity .25s ease;
    }
    .collapsible[data-open="true"] {
      max-height:600px;
      opacity:1;
    }
    .pwd { display:flex; gap:8px; align-items:center; }
    .pwd button { flex:0 0 auto; background: var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:14px; line-height:1; display:flex; align-items:center; justify-content:center; }
    .pwd button:hover { background: var(--accent-hover); }
    .help { font-weight:600; color: var(--accent); cursor:help; display:inline-flex; align-items:center; justify-content:center; margin-left:6px; border:1px solid var(--accent); background: rgba(37,99,235,0.07); border-radius:50%; width:18px; height:18px; line-height:16px; text-align:center; font-size:11px; }
    .helptext { color: var(--text-soft); font-size:12px; line-height:1.4; margin-top:6px; }
    .status { margin-top:8px; min-height:1.2em; font-size:13px; font-weight:500; color: var(--accent); transition: opacity .3s; }
    .status.error { color: var(--danger); }
    .totp-row { display:flex; align-items:center; gap:14px; }
    #totpRing { width:28px; height:28px; border-radius:50%; background: conic-gradient(var(--accent) var(--deg,0deg), #e0e0e0 0deg); transition: background .2s linear; border:2px solid var(--border); box-shadow: inset 0 0 0 2px var(--bg-alt); }
    #twoFASetup { margin-top:8px; }
    #twoFARegistered { display:none; align-items:center; gap:10px; }
    #twoFARegistered button, #twoFARegister { background: var(--accent); color:#fff; border:none; padding:6px 14px; font-size:13px; border-radius:8px; cursor:pointer; font-weight:500; }
    #twoFARegistered button:hover, #twoFARegister:hover { background: var(--accent-hover); }
    #twoFARemove { background: var(--danger); }
    #twoFARemove:hover { filter: brightness(.9); }
    #preview { background: linear-gradient(135deg,var(--bg-alt),rgba(255,255,255,0.6)); border:1px solid var(--border); padding:10px 12px; border-radius:8px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.25), 0 1px 1px rgba(0,0,0,0.05); }
    #footerNote { max-width:980px; margin:0 auto 32px; padding:0 28px; font-size:12px; color: var(--text-soft); text-align:right; }
    .toast { position:fixed; bottom:18px; right:20px; background: var(--accent); color:#fff; padding:10px 14px; border-radius:8px; font-size:13px; font-weight:500; box-shadow: var(--shadow); opacity:0; transform: translateY(6px); pointer-events:none; transition: opacity .28s, transform .28s; }
    .toast.show { opacity:1; transform: translateY(0); }
    a { color: var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .addrList { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .addrCopy { background: var(--bg-alt); color: var(--accent); border:1px solid var(--border); padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer; box-shadow: var(--shadow-sm); }
    .addrCopy:hover { border-color: var(--accent); }
  </style>
</head>
<body>
  <div id="topBar">
    <div style="display:flex; flex-direction:column; gap:2px;">
      <h2>Dashboard Settings</h2>
      <div class="meta"><span id="appVersion">Version —</span><span id="status" class="status"></span></div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button type="button" id="saveBtn" onclick="document.getElementById('cfg').requestSubmit()" title="Save settings (Ctrl+S)">Save</button>
    </div>
  </div>
  <div id="layout">
  <form id="cfg">
    <fieldset>
      <legend>Target</legend>
      <label>URL</label>
      <input id="url" type="text" placeholder="https://..." />
  <label>SESSION <span class="help" title="Managed automatically and cannot be edited here.">?</span></label>
  <input id="session" type="text" placeholder="auto-managed" disabled />
    </fieldset>

    <fieldset>
      <legend>Web Relay</legend>
      <label class="toggle">
        <span class="toggle-text">
          Enable local/open server
          <span class="help" title="Starts a tiny HTTP server to accept /open requests and navigate the existing window. By default binds to 0.0.0.0 on port 793 (reachable from LAN).">?</span>
        </span>
        <input id="loopEnabled" type="checkbox" />
      </label>
      <div id="loopFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <div class="row">
          <div style="grid-column: 1 / -1;">
            <label>Access URLs</label>
            <div id="serverLan" class="helptext">—</div>
          </div>
          <div>
            <label>Port</label>
            <input id="loopPort" type="number" min="1" max="65535" step="1" placeholder="793" />
          </div>
        </div>
        <label class="toggle" style="margin-top:12px;">
          <span class="toggle-text">Minimize to tray while server runs</span>
          <input id="minimizeToTray" type="checkbox" />
        </label>
  <div class="helptext">Security: When bound to 0.0.0.0, the endpoint is reachable from your LAN (http://&lt;lan-ip&gt;:793/). Use OS firewall rules or network segmentation as needed.</div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Login</legend>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="text" />
        </div>
        <div>
          <label>Password</label>
          <div class="pwd">
            <input id="password" type="password" />
            <button type="button" id="togglePwd" title="Show/Hide">👁️</button>
          </div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label class="toggle">
          <span class="toggle-text">
            Enable 2FA autofill during login
            <span class="help" title="Auto-fill the one-time code on 2FA screens using a TOTP secret. The code updates every 30s.">?</span>
          </span>
          <input id="twoFAEnabled" type="checkbox" />
        </label>
      </div>
      <div id="twoFASetup" style="display:none;">
        <div id="twoFAInputRow">
          <label>Secret Key (TOTP)</label>
          <input id="twoFASecret" type="text" placeholder="JBSWY3DPEHPK3PXP or otpauth://..." />
          <div class="helptext">Paste your secret and click Register. Stored encrypted with your login details. You can remove it anytime.</div>
          <div style="margin-top:6px;"><button type="button" id="twoFARegister">Register</button></div>
        </div>
        <div id="twoFARegistered" class="totp-row">
          <span style="color:#2e7d32; font-weight:600;">Registered</span>
          <button type="button" id="twoFARemove">Remove Key</button>
        </div>
        <div id="totpPreviewWrap" style="display:none;margin-top:8px;">
          <label>Current Code <span class="help" title="Code refreshes every 30 seconds. The circle shows time remaining.">?</span></label>
          <div class="totp-row">
            <div id="totpRing"></div>
            <div id="totpPreview" style="font: 600 20px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">—</div>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Page Behavior</legend>
      <div class="row">
        <div>
          <label>
            Keep Alive (sec)
            <span class="help" title="Sends periodic HEAD requests to keep sessions alive. 0 disables.">?</span>
          </label>
          <input id="keepAliveSec" type="number" min="0" step="1" />
        </div>
        <div>
          <label>
            Wait For CSS (optional)
            <span class="help" title="Wait until a CSS selector appears before starting the reload timer.">?</span>
          </label>
          <input id="waitForCss" type="text" placeholder="#selector" />
        </div>
      </div>
      <label class="toggle">
        <span class="toggle-text">
          Auto Refresh Enabled
          <span class="help" title="Turn on periodic page reloads using the interval below.">?</span>
        </span>
        <input id="autoReloadEnabled" type="checkbox" />
      </label>
      <div id="autoReloadFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <label>
          Reload After (sec)
          <span class="help" title="Time between automatic page reloads. Use 250 seconds by default. When Rolling Window is enabled, this must be less than the window duration.">?</span>
        </label>
        <input id="reloadAfterSec" type="number" min="1" step="1" />
        <div id="ruleWarn" class="status error" style="display:none; margin-top:4px;"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Rolling Window</legend>
      <label class="toggle">
        <span class="toggle-text">
          Enable rolling window
          <span class="help" title="Append from/to timestamps for a daily rolling window starting at the chosen time.">?</span>
        </span>
        <input id="twEnabled" type="checkbox" />
      </label>
      <div id="twFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <div>
          <label>
            Daily start (HH:MM)
            <span class="help" title="Local time to start each daily window. Disabled if rolling window is off.">?</span>
          </label>
          <input id="twStart" type="text" placeholder="12:00" />
        </div>
        <div style="margin-top:8px;">
          <label>
            Duration
            <span class="help" title="Length of each rolling window.">?</span>
          </label>
          <select id="twDuration">
            <option value="1h">1h</option>
            <option value="2h">2h</option>
            <option value="6h">6h</option>
            <option value="12h">12h</option>
            <option value="1d">1d</option>
            <option value="2d">2d</option>
            <option value="5d">5d</option>
            <option value="7d">7d</option>
          </select>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Time Source</legend>
      <label class="toggle">
        <span class="toggle-text">
          Use local PC time
          <span class="help" title="When enabled, the app skips NTP lookups and uses the kiosk's system clock for TOTP codes.">?</span>
        </span>
        <input id="useSystemTime" type="checkbox" />
      </label>
      <div id="ntpFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <label>
          NTP Server
          <span class="help" title="Optional hostname(s) of the NTP server used to correct clock drift when generating TOTP codes.">?</span>
        </label>
        <input id="ntpServer" type="text" placeholder="pool.ntp.org" />
        <div class="helptext">Leave blank to fall back to local PC time. Multiple servers can be comma separated.</div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Proxy (Squid)</legend>
      <label class="toggle">
        <span class="toggle-text">
          Use HTTP/HTTPS proxy
          <span class="help" title="Enable when routing traffic through a Squid-compatible HTTP proxy.">?</span>
        </span>
        <input id="proxyEnabled" type="checkbox" />
      </label>
      <div id="proxyFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <div class="row">
          <div>
            <label>Proxy Host</label>
            <input id="proxyHost" type="text" placeholder="proxy.example.com" />
          </div>
          <div>
            <label>Proxy Port</label>
            <input id="proxyPort" type="number" min="1" max="65535" step="1" placeholder="3128" />
          </div>
        </div>
        <label class="toggle" style="margin-top:12px;">
          <span class="toggle-text">
            Proxy uses HTTPS
            <span class="help" title="Also send HTTPS requests through the same proxy host and port. Leave off if the proxy only accepts HTTP.">?</span>
          </span>
          <input id="proxyUseHttps" type="checkbox" />
        </label>
        <div class="helptext">Proxy settings apply immediately after you toggle or edit the fields.</div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Navigation</legend>
      <label class="toggle">
        <span class="toggle-text">
          Navigate back to default URL
          <span class="help" title="If the page navigates away, return to the configured URL. Requires a positive child tab timeout.">?</span>
        </span>
        <input id="navigateBackEnabled" type="checkbox" />
      </label>
      <div id="navBackFields" class="collapsible" data-open="false" style="margin-top:8px;">
        <label>
          Return to default after inactivity (sec)
          <span class="help" title="After this many seconds of being away from the default URL, automatically return to it. Use 250 seconds by default. Set 0 to disable.">?</span>
        </label>
        <input id="tabTimeoutSec" type="number" min="0" step="1" placeholder="0 = never" />
      </div>
    </fieldset>

    <div style="margin-top:12px;">
      <label>Preview URL</label>
      <div id="preview" style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; word-break: break-all; background:#f6f8fa; border:1px solid #e1e4e8; padding:8px; border-radius:4px;">—</div>
    </div>
  </form>
  </div>
  <div id="footerNote"><span id="year"></span> By Ankit Seal</div>
  <div class="toast" id="toastMsg">Saved</div>
  <script>
    const api = window.Settings;
    const NTP_DEFAULT_HOST = 'uk.pool.ntp.org';
  function val(id){ return document.getElementById(id).value; }
    function sanitizeProxyHostValue(raw, portInput) {
      if (!raw) return '';
      let trimmed = String(raw).trim();
      trimmed = trimmed.replace(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//, '');
      trimmed = trimmed.split('/')[0];
      let extractedPort = null;
      if (trimmed.startsWith('[')) {
        const end = trimmed.indexOf(']');
        if (end !== -1) {
          const remainder = trimmed.slice(end + 1);
          if (remainder.startsWith(':')) {
            const candidate = remainder.slice(1);
            if (/^[0-9]+$/.test(candidate)) {
              extractedPort = candidate;
            }
          }
          trimmed = trimmed.slice(0, end + 1);
        }
      } else {
        const colonIndex = trimmed.lastIndexOf(':');
        if (colonIndex > -1) {
          const candidate = trimmed.slice(colonIndex + 1);
          if (/^[0-9]+$/.test(candidate)) {
            extractedPort = candidate;
            trimmed = trimmed.slice(0, colonIndex);
          }
        }
      }
      if (portInput && extractedPort && (!portInput.value || Number(portInput.value) <= 0)) {
        portInput.value = extractedPort;
      }
      return trimmed;
    }
    function setVal(id,v){
      if (id === 'proxyHost') {
        document.getElementById(id).value = sanitizeProxyHostValue(v, document.getElementById('proxyPort'));
        return;
      }
      document.getElementById(id).value = v ?? '';
    }
    function setChk(id,v){ document.getElementById(id).checked = !!v; }

    async function load(){
  const cfg = await api.getConfig();
  const twoFA = await api.get2FAState().catch(() => ({ enabled:false, hasSecret:false }));
      setVal('url', cfg.url);
      setVal('session', cfg.session);
      setVal('email', cfg.user?.email);
      setVal('password', cfg.user?.password);
  setVal('keepAliveSec', cfg.keepAliveSec);
  setVal('reloadAfterSec', cfg.reloadAfterSec);
  setVal('waitForCss', cfg.waitForCss);
  setVal('ntpServer', cfg.ntpServer || '');
  setChk('useSystemTime', !!cfg.useSystemTime);
  const ntpInput = document.getElementById('ntpServer');
  const ntpToggle = document.getElementById('useSystemTime');
  if (ntpInput && ntpToggle && !ntpToggle.checked && !ntpInput.value.trim()) {
    ntpInput.value = NTP_DEFAULT_HOST;
  }
  setChk('proxyEnabled', !!cfg.proxyEnabled);
  setVal('proxyHost', cfg.proxyHost || '');
  setVal('proxyPort', Number.isFinite(Number(cfg.proxyPort)) && Number(cfg.proxyPort) > 0 ? Number(cfg.proxyPort) : '');
  setChk('proxyUseHttps', cfg.proxyUseHttps === undefined ? true : !!cfg.proxyUseHttps);
  // Loopback
  setChk('loopEnabled', !!cfg.loopback?.enabled);
  const lf = document.getElementById('loopFields');
  if (lf) lf.dataset.open = cfg.loopback?.enabled ? 'true' : 'false';
  const lan = document.getElementById('serverLan');
  const port = (cfg.serverInfo?.port || 793);
  const addrsRaw = Array.isArray(cfg.serverInfo?.addresses) ? cfg.serverInfo.addresses : [];
  const unique = Array.from(new Set(addrsRaw.filter(Boolean)));
  if (lan) {
    if (unique.length) {
      lan.innerHTML = '<div class="addrList">' + unique.map(ip => {
        const u = 'http://' + ip + ':' + port + '/';
        return '<button type="button" class="addrCopy" data-url="'+u+'">'+u+'</button>';
      }).join('') + '</div>';
    } else {
      lan.textContent = '—';
    }
  }
  const loopPortInput = document.getElementById('loopPort');
  if (loopPortInput) loopPortInput.value = Number.isFinite(Number(cfg.loopback?.port)) && Number(cfg.loopback.port) > 0 ? Number(cfg.loopback.port) : 793;
  setChk('minimizeToTray', !!cfg.loopback?.minimizeToTray);
  setChk('twEnabled', cfg.timeWindow?.enabled);
  // Default twStart to 12:00 when enabled but missing
  const startVal = (cfg.timeWindow?.enabled && (!cfg.timeWindow?.start || !String(cfg.timeWindow.start).trim())) ? '12:00' : cfg.timeWindow?.start;
  setVal('twStart', startVal);
    // Set duration dropdown
    const _twDurationEl = document.getElementById('twDuration');
    if (_twDurationEl) { _twDurationEl.value = (cfg.timeWindow?.duration || '1d'); }
  setChk('autoReloadEnabled', !!cfg.autoReloadEnabled);
  updateReloadInputs();
  setChk('navigateBackEnabled', !!cfg.navigateBackEnabled);
  // 2FA state
  setChk('twoFAEnabled', !!twoFA.enabled);
  await update2FAUI(twoFA);
  // Default tab timeout to 250 when enabled but invalid/missing
  let tabTo = Number.isFinite(cfg.tabTimeoutSec) ? cfg.tabTimeoutSec : NaN;
  if (!!cfg.navigateBackEnabled && (!Number.isFinite(tabTo) || tabTo <= 0)) tabTo = 250;
  setVal('tabTimeoutSec', Number.isFinite(tabTo) ? tabTo : 0);
  updateTwInputs();
  updateNtpInputs();
  updateProxyInputs();
  scheduleNtpPreferenceUpdate();
  scheduleProxyPreferenceUpdate();
    }

  document.getElementById('cfg').addEventListener('submit', async (e) => {
      e.preventDefault();
      const toggleOn = document.getElementById('autoReloadEnabled').checked;
      let ra = Number(val('reloadAfterSec'));
      if (toggleOn && (!Number.isFinite(ra) || ra <= 0)) {
        ra = 250; // default when enabling
        setVal('reloadAfterSec', ra);
      }
      if (!toggleOn) {
        ra = 0; // force off when disabled
      }

  // Normalize rolling window start and tab timeout defaults per request
  const twOn = document.getElementById('twEnabled').checked;
  let twStart = val('twStart');
  if (twOn && (!twStart || !String(twStart).trim())) twStart = '12:00';

  const navBackOn = document.getElementById('navigateBackEnabled').checked;
  let tabTimeout = Number(document.getElementById('tabTimeoutSec').value||0);
  if (navBackOn && (!Number.isFinite(tabTimeout) || tabTimeout <= 0)) tabTimeout = 250;

  const payload = {
        url: val('url'),
  // session value is read-only in UI; include existing value for completeness
  session: document.getElementById('session').value,
        keepAliveSec: Number(val('keepAliveSec')||0),
        reloadAfterSec: ra,
        waitForCss: val('waitForCss') || null,
        user: { email: val('email'), password: val('password') },
    timeWindow: { enabled: twOn, start: twStart || '12:00', duration: (document.getElementById('twDuration') ? document.getElementById('twDuration').value : '1d') },
  autoReloadEnabled: toggleOn,
  navigateBackEnabled: navBackOn,
  tabTimeoutSec: tabTimeout,
  useSystemTime: document.getElementById('useSystemTime').checked,
  ntpServer: val('ntpServer').trim(),
  proxyEnabled: document.getElementById('proxyEnabled').checked,
  proxyHost: sanitizeProxyHostValue(val('proxyHost'), document.getElementById('proxyPort')),
  proxyPort: Number(document.getElementById('proxyPort').value),
  proxyUseHttps: document.getElementById('proxyUseHttps') ? document.getElementById('proxyUseHttps').checked : false
      ,
  loopback: {
    enabled: document.getElementById('loopEnabled').checked,
    port: Number(document.getElementById('loopPort').value) || 793,
    minimizeToTray: document.getElementById('minimizeToTray').checked
  }
      };
      const st = document.getElementById('status');
      try {
        const res = await api.saveConfig(payload);
        if (res && res.ok) { st.textContent = 'Saved'; st.classList.remove('error');
          if (res.loopbackStatus && res.loopbackStatus.error) {
            showToast('Server error: ' + res.loopbackStatus.error, 'error');
          } else {
            showToast('Settings saved');
          }
          // Refresh addresses and port from main after restart
          try {
            const cfg2 = await api.getConfig();
            // Update Access URLs and port display
            const lan = document.getElementById('serverLan');
            const port2 = (cfg2.serverInfo?.port || 793);
            const addrsRaw = Array.isArray(cfg2.serverInfo?.addresses) ? cfg2.serverInfo.addresses : [];
            const unique = Array.from(new Set(addrsRaw.filter(Boolean)));
            if (lan) {
              if (unique.length) {
                lan.innerHTML = '<div class="addrList">' + unique.map(ip => {
                  const u = 'http://' + ip + ':' + port2 + '/';
                  return '<button type="button" class="addrCopy" data-url="'+u+'">'+u+'</button>';
                }).join('') + '</div>';
              } else {
                lan.textContent = '—';
              }
            }
            const loopPortInput = document.getElementById('loopPort');
            if (loopPortInput) loopPortInput.value = Number.isFinite(Number(cfg2.loopback?.port)) && Number(cfg2.loopback.port) > 0 ? Number(cfg2.loopback.port) : 793;
          } catch {}
        }
        else { st.textContent = 'Error'; st.classList.add('error'); showToast('Save failed','error'); }
      } catch (err) {
        st.textContent = 'Error';
        st.classList.add('error');
        showToast('Save error','error');
      }
      setTimeout(() => { st.textContent = ''; st.classList.remove('error'); }, 2600);
    });

    // Copy-to-clipboard for address buttons
    document.addEventListener('click', async (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('addrCopy') && t.dataset && t.dataset.url) {
        try {
          await navigator.clipboard.writeText(t.dataset.url);
          showToast('Copied: ' + t.dataset.url);
        } catch (err) {
          // Fallback: select text via temporary input
          const tmp = document.createElement('input');
          tmp.style.position = 'fixed'; tmp.style.opacity = '0'; tmp.value = t.dataset.url;
          document.body.appendChild(tmp); tmp.select();
          try { document.execCommand('copy'); showToast('Copied'); } catch {}
          document.body.removeChild(tmp);
        }
      }
    });

    function updateReloadInputs() {
      const on = document.getElementById('autoReloadEnabled').checked;
      const ra = document.getElementById('reloadAfterSec');
      const wrap = document.getElementById('autoReloadFields');
      ra.disabled = !on;
      ra.min = on ? '1' : '0';
      if (wrap) wrap.dataset.open = on ? 'true' : 'false';
  updateRule();
    }

    document.getElementById('autoReloadEnabled').addEventListener('change', () => {
      updateReloadInputs();
      const on = document.getElementById('autoReloadEnabled').checked;
      let v = Number(val('reloadAfterSec'));
      if (on && (!Number.isFinite(v) || v <= 0)) setVal('reloadAfterSec', 250);
      if (!on) setVal('reloadAfterSec', 0);
  updateRule();
    });

    let ntpUpdateTimer = null;
    function scheduleNtpPreferenceUpdate() {
      try { clearTimeout(ntpUpdateTimer); } catch {}
      ntpUpdateTimer = setTimeout(() => {
        const toggle = document.getElementById('useSystemTime');
        const input = document.getElementById('ntpServer');
        if (!toggle || !input) return;
        api.setNtpPreference(input.value.trim(), toggle.checked).catch(() => {});
      }, 250);
    }
    function updateNtpInputs() {
      const toggle = document.getElementById('useSystemTime');
      const input = document.getElementById('ntpServer');
      const wrap = document.getElementById('ntpFields');
      if (!toggle || !input) return;
      input.disabled = toggle.checked;
      if (wrap) wrap.dataset.open = toggle.checked ? 'false' : 'true';
    }
    let proxyUpdateTimer = null;
    function scheduleProxyPreferenceUpdate() {
      try { clearTimeout(proxyUpdateTimer); } catch {}
      proxyUpdateTimer = setTimeout(() => {
        const enabled = document.getElementById('proxyEnabled');
        const host = document.getElementById('proxyHost');
        const port = document.getElementById('proxyPort');
        const httpsToggle = document.getElementById('proxyUseHttps');
        if (!enabled || !host || !port || !httpsToggle) return;
  const cleanHost = sanitizeProxyHostValue(host.value, port);
        if (cleanHost !== host.value) {
          host.value = cleanHost;
        }
        api.setProxyPreference({
          enabled: enabled.checked,
          host: cleanHost,
          port: Number(port.value),
          useHttps: httpsToggle.checked
        }).then((res) => {
          if (!res || !enabled) return;
          if (typeof res.enabled === 'boolean' && res.enabled !== enabled.checked) {
            enabled.checked = res.enabled;
            updateProxyInputs();
          }
          if (typeof res.useHttps === 'boolean' && httpsToggle) {
            httpsToggle.checked = res.useHttps;
          }
        }).catch(() => {});
      }, 250);
    }
    function updateProxyInputs() {
      const enabled = document.getElementById('proxyEnabled');
      const host = document.getElementById('proxyHost');
      const port = document.getElementById('proxyPort');
      const httpsToggle = document.getElementById('proxyUseHttps');
      const wrap = document.getElementById('proxyFields');
      if (!enabled || !host || !port) return;
      const disableFields = !enabled.checked;
      host.disabled = disableFields;
      port.disabled = disableFields;
      if (httpsToggle) httpsToggle.disabled = disableFields;
      if (wrap) wrap.dataset.open = disableFields ? 'false' : 'true';
    }
    const useSystemToggle = document.getElementById('useSystemTime');
    if (useSystemToggle) {
      useSystemToggle.addEventListener('change', () => {
        if (!useSystemToggle.checked) {
          const field = document.getElementById('ntpServer');
          if (field && !field.value.trim()) {
            field.value = NTP_DEFAULT_HOST;
          }
        }
        updateNtpInputs();
        scheduleNtpPreferenceUpdate();
      });
    }
    const ntpServerInput = document.getElementById('ntpServer');
    if (ntpServerInput) {
      ntpServerInput.addEventListener('input', () => {
        scheduleNtpPreferenceUpdate();
      });
      ntpServerInput.addEventListener('blur', () => {
        const toggle = document.getElementById('useSystemTime');
        if (toggle && !toggle.checked && !ntpServerInput.value.trim()) {
          ntpServerInput.value = NTP_DEFAULT_HOST;
        }
        scheduleNtpPreferenceUpdate();
      });
    }
    const proxyToggle = document.getElementById('proxyEnabled');
  const proxyHostInput = document.getElementById('proxyHost');
  const proxyPortInput = document.getElementById('proxyPort');
  const proxyHttpsToggle = document.getElementById('proxyUseHttps');
    if (proxyToggle) {
      proxyToggle.addEventListener('change', () => {
        updateProxyInputs();
        scheduleProxyPreferenceUpdate();
      });
    }
    if (proxyHostInput) {
      proxyHostInput.addEventListener('input', scheduleProxyPreferenceUpdate);
      proxyHostInput.addEventListener('blur', () => {
  const clean = sanitizeProxyHostValue(proxyHostInput.value, document.getElementById('proxyPort'));
        if (clean !== proxyHostInput.value) proxyHostInput.value = clean;
        scheduleProxyPreferenceUpdate();
      });
    }
    if (proxyPortInput) {
      proxyPortInput.addEventListener('input', scheduleProxyPreferenceUpdate);
      proxyPortInput.addEventListener('blur', () => {
        const valNum = Number(proxyPortInput.value);
        if (!Number.isFinite(valNum) || valNum <= 0) {
          proxyPortInput.value = '';
        }
        scheduleProxyPreferenceUpdate();
      });
    }
    if (proxyHttpsToggle) {
      proxyHttpsToggle.addEventListener('change', scheduleProxyPreferenceUpdate);
    }

    document.getElementById('togglePwd').addEventListener('click', () => {
      const p = document.getElementById('password');
      p.type = p.type === 'password' ? 'text' : 'password';
    });

    // 2FA handling: toggle, secret input, live preview & ring
    async function update2FAUI(twoFAState){
      const on = document.getElementById('twoFAEnabled').checked;
      const setup = document.getElementById('twoFASetup');
      const inputRow = document.getElementById('twoFAInputRow');
      const regRow = document.getElementById('twoFARegistered');
      const wrap = document.getElementById('totpPreviewWrap');
      setup.style.display = on ? '' : 'none';
      if (!on) { wrap.style.display='none'; stopTotpTimer(); return; }
      const hasSecret = !!(twoFAState && twoFAState.hasSecret);
      inputRow.style.display = hasSecret ? 'none' : '';
      regRow.style.display = hasSecret ? 'inline-flex' : 'none';
      wrap.style.display = hasSecret ? '' : 'none';
      if (hasSecret) startTotpTimer(true); else stopTotpTimer();
    }
    document.getElementById('twoFAEnabled').addEventListener('change', async () => {
      const on = document.getElementById('twoFAEnabled').checked;
      await api.set2FAEnabled(on).catch(()=>{});
      const state = await api.get2FAState().catch(()=>({enabled:on, hasSecret:false}));
      await update2FAUI(state);
    });
    document.getElementById('twoFARegister').addEventListener('click', async () => {
      const sec = val('twoFASecret');
      if (!sec) return;
      await api.set2FASecret(sec).catch(()=>{});
      document.getElementById('twoFASecret').value = '';
      const state = await api.get2FAState().catch(()=>({enabled:true, hasSecret:true}));
      await update2FAUI(state);
    });
    document.getElementById('twoFARemove').addEventListener('click', async () => {
      await api.remove2FASecret().catch(()=>{});
      const state = await api.get2FAState().catch(()=>({enabled:true, hasSecret:false}));
      await update2FAUI(state);
    });

    let totpTimer = null;
    function stopTotpTimer(){ if (totpTimer) { clearInterval(totpTimer); totpTimer = null; } }
    async function startTotpTimer(force){
      const el = document.getElementById('totpPreview');
      const ring = document.getElementById('totpRing');
      async function tick(){
        try {
          const code = await api.getTOTPCode();
          el.textContent = code || '—';
        } catch { el.textContent = '—'; }
        // ring progress (countdown)
        const step = 30;
        const now = Math.floor(Date.now()/1000);
        const rem = step - (now % step);
        const deg = Math.max(0, Math.min(360, Math.round(rem/step*360)));
        ring.style.setProperty('--deg', deg + 'deg');
      }
      if (!totpTimer || force) {
        stopTotpTimer();
        await tick();
        totpTimer = setInterval(tick, 1000);
      }
    }

    // Kick off initial TOTP UI
    setTimeout(async () => {
      const twoFA = await api.get2FAState().catch(()=>({enabled:false, hasSecret:false}));
      await update2FAUI(twoFA);
    }, 200);

    // Rolling window inputs
    function updateTwInputs() {
      const on = document.getElementById('twEnabled').checked;
      const input = document.getElementById('twStart');
      const dur = document.getElementById('twDuration');
      const wrap = document.getElementById('twFields');
      input.disabled = !on;
      if (dur) dur.disabled = !on;
      if (on) {
        const cur = String(input.value||'').trim();
        if (!cur) input.value = '12:00';
      }
      if (wrap) wrap.dataset.open = on ? 'true' : 'false';
      updatePreview();
    }
    document.getElementById('twEnabled').addEventListener('change', updateTwInputs);
  document.getElementById('twStart').addEventListener('input', () => { updatePreview(); updateRule(); });
  const _twDurEl = document.getElementById('twDuration');
  if (_twDurEl) _twDurEl.addEventListener('change', () => { updatePreview(); updateRule(); });

    // Loopback UI
    function updateLoopInputs(){
      const on = document.getElementById('loopEnabled').checked;
      const wrap = document.getElementById('loopFields');
      if (wrap) wrap.dataset.open = on ? 'true' : 'false';
    }
    const loopToggle = document.getElementById('loopEnabled');
    if (loopToggle) loopToggle.addEventListener('change', updateLoopInputs);

    // Link tab timeout to navigate-back; 0 disables navigate back
    function updateNavBackInputs() {
      const chk = document.getElementById('navigateBackEnabled');
      const input = document.getElementById('tabTimeoutSec');
      const wrap = document.getElementById('navBackFields');
      if (!chk.checked) {
        input.disabled = true;
        input.min = '0';
        input.value = '0';
      } else {
        input.disabled = false;
        input.min = '1';
        const v = Number(input.value || 0);
        if (!Number.isFinite(v) || v <= 0) {
          input.value = '250'; // default like Reload After
        }
      }
      if (wrap) wrap.dataset.open = chk.checked ? 'true' : 'false';
    }
    function onTimeoutInput() {
      const input = document.getElementById('tabTimeoutSec');
      const chk = document.getElementById('navigateBackEnabled');
      const to = Number(input.value || 0);
      if (!Number.isFinite(to) || to <= 0) {
        chk.checked = false;
        updateNavBackInputs();
      }
    }
    document.getElementById('tabTimeoutSec').addEventListener('input', onTimeoutInput);
    document.getElementById('navigateBackEnabled').addEventListener('change', updateNavBackInputs);

    // Build a live preview of the effective URL with from/to parameters
    function pad(n){ return String(n).padStart(2,'0'); }
    function normalizeUrl(u){
      if (!u) return '';
      const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(u);
      return hasScheme ? u : ('https://' + u);
    }
    function durationToMs(label){
      const map = { '1h':3600000,'2h':7200000,'6h':21600000,'12h':43200000,'1d':86400000,'2d':172800000,'5d':432000000,'7d':604800000 };
      if (map[label]) return map[label];
      const h = parseInt(String(label||'').replace(/[^0-9]/g,''),10);
      return Number.isFinite(h) && h>0 ? h*3600000 : 86400000;
    }
    function computeWindowPreview(startHM, durationLabel){
      const parts = String(startHM||'12:00').split(':');
      const sh = Math.max(0, Math.min(23, parseInt(parts[0]||'12',10)||0));
      const sm = Math.max(0, Math.min(59, parseInt(parts[1]||'0',10)||0));
      const now = new Date();
      const durMs = durationToMs(durationLabel||'1d');
      const dayMs = 86400000;
      let from = new Date(now.getFullYear(), now.getMonth(), now.getDate(), sh, sm, 0, 0);
      if (now < from) from = new Date(from.getTime() - dayMs);
      let to = new Date(from.getTime() + durMs);
      while (now >= to) { from = new Date(from.getTime() + dayMs); to = new Date(from.getTime() + durMs); }
      return { from: from.getTime(), to: to.getTime() };
    }
    function withWindowParams(baseUrl, win){
      try{
        const u = new URL(normalizeUrl(baseUrl));
        u.searchParams.set('from', String(win.from));
        u.searchParams.set('to', String(win.to));
        return u.toString();
      }catch{ return normalizeUrl(baseUrl); }
    }
    function updatePreview(){
      const el = document.getElementById('preview');
      const base = val('url');
      const on = document.getElementById('twEnabled').checked;
      if (!base) { el.textContent = 'Enter a URL to preview'; return; }
      if (!on) { el.textContent = normalizeUrl(base); return; }
      const start = val('twStart') || '12:00';
      const dur = document.getElementById('twDuration') ? document.getElementById('twDuration').value : '1d';
      const win = computeWindowPreview(start, dur);
      el.textContent = withWindowParams(base, win);
    }
    // Hook preview updates
    document.getElementById('url').addEventListener('input', updatePreview);
    document.getElementById('twEnabled').addEventListener('change', updatePreview);
  document.getElementById('reloadAfterSec').addEventListener('input', () => { updateRule(); });

    // Call after load to set initial state
    const _origLoad = load;
    load = async function() {
      await _origLoad();
      updateNavBackInputs();
    };

    // Validation: reloadAfter must be < rolling window duration when both enabled
    function getDurationSec(){
      const el = document.getElementById('twDuration');
      const label = el ? el.value : '1d';
      const map = { '1h':3600,'2h':7200,'6h':21600,'12h':43200,'1d':86400,'2d':172800,'5d':432000,'7d':604800 };
      if (map[label]) return map[label];
      const h = parseInt(String(label||'').replace(/[^0-9]/g,''),10);
      return Number.isFinite(h) && h>0 ? h*3600 : 86400;
    }
    function updateRule(){
      const warn = document.getElementById('ruleWarn');
      const onRoll = document.getElementById('twEnabled').checked;
      const onAuto = document.getElementById('autoReloadEnabled').checked;
      const raEl = document.getElementById('reloadAfterSec');
      const ra = Number(raEl.value||0);
      const dur = getDurationSec();
      // Set max when applicable
      if (onRoll && onAuto) {
        raEl.max = String(Math.max(1, dur-1));
      } else {
        raEl.removeAttribute('max');
      }
      const bad = onRoll && onAuto && Number.isFinite(ra) && ra >= dur;
      if (bad) {
        warn.style.display = '';
        warn.textContent = `Reload interval (${ra}s) must be less than rolling window duration (${dur}s).`;
        raEl.style.borderColor = '#a00';
      } else {
        warn.style.display = 'none';
        warn.textContent = '';
        raEl.style.borderColor = '';
      }
      return !bad;
    }

    // Override submit to enforce rule before saving
    const _origSubmit = document.getElementById('cfg').onsubmit;
    // rewire our existing listener: we already addEventListener('submit', ...) earlier
    const form = document.getElementById('cfg');
    form.addEventListener('submit', (e) => {
      if (!updateRule()) {
        e.preventDefault();
        const st = document.getElementById('status');
        st.textContent = 'Fix errors before saving.';
        st.classList.add('error');
        setTimeout(() => { st.textContent=''; st.classList.remove('error'); }, 2500);
      }
    }, true);

  load().then(async () => { updatePreview(); updateRule(); try { const v = await api.getVersion(); document.getElementById('appVersion').textContent = 'Version ' + (v && v.version ? v.version : ''); } catch {}; document.getElementById('year').textContent = new Date().getFullYear(); });

    // Keyboard shortcut Ctrl+S for save
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); document.getElementById('cfg').requestSubmit(); }
    });

    function showToast(msg,type){
      const t = document.getElementById('toastMsg');
      t.textContent = msg;
      t.style.background = (type==='error') ? 'var(--danger)' : 'var(--accent)';
      t.classList.add('show');
      clearTimeout(t.__hide);
      t.__hide = setTimeout(()=>{ t.classList.remove('show'); }, 2200);
    }
  </script>
</body>
</html>
